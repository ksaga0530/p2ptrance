<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Share</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            color: #111827;
        }
        
        /* Navigation */
        .nav {
            border-bottom: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            items: center;
            justify-content: space-between;
        }
        
        .nav h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: -0.025em;
            color: #111827;
        }
        
        .nav-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.875rem;
        }
        
        .status-text {
            color: #6b7280;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 4rem;
        }
        
        .header h2 {
            font-size: 3rem;
            font-weight: 200;
            color: #111827;
            margin-bottom: 1rem;
            letter-spacing: -0.025em;
        }
        
        .header p {
            font-size: 1.25rem;
            color: #6b7280;
            font-weight: 300;
            max-width: 32rem;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-bottom: 3rem;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            border-bottom: 1px solid #f3f4f6;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #111827;
            letter-spacing: -0.025em;
        }
        
        .card-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .card-content {
            padding: 2rem;
        }
        
        /* Status */
        .status {
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .status.disconnected {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status.connecting {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
        
        .status.connected {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        /* Form Elements */
        input, button, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #6b7280;
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
        }
        
        button {
            background: #111827;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 0.75rem;
            transition: all 0.3s ease;
        }
        
        button:hover:not(:disabled) {
            background: #1f2937;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: transparent !important;
            color: #6b7280 !important;
            border: 1px solid #d1d5db !important;
        }
        
        .btn-secondary:hover:not(:disabled) {
            color: #111827 !important;
            background: #f3f4f6 !important;
        }
        
        /* Message Section */
        .message-section {
            grid-column: 1 / -1;
        }
        
        .input-area {
            position: relative;
        }
        
        textarea {
            height: 6rem;
            resize: vertical;
            padding-right: 5rem;
        }
        
        .input-buttons {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .input-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            cursor: pointer;
            font-size: 0.625rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
        }
        
        .file-btn {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        
        .paste-btn {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        
        .input-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            color: #6b7280;
            margin: 1rem 0;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .drop-zone.dragover {
            border-color: #6b7280;
            background: #f9fafb;
            color: #111827;
        }
        
        /* File Preview */
        .preview-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.625rem;
            font-weight: 700;
            color: #6b7280;
        }
        
        .image-preview {
            max-width: 9rem;
            max-height: 9rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .file-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .clear-btn {
            margin-top: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        /* Message History */
        .message-history {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            max-height: 18rem;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
        
        .message {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .message.sent {
            background: #111827;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.received {
            background: #e0f2fe;
            color: #0277bd;
            margin-right: auto;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.375rem;
        }
        
        /* File Messages */
        .file-message {
            max-width: 18rem;
        }
        
        .file-info-display {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 0.375rem 0;
        }
        
        .file-download {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }
        
        .file-download:hover {
            background: #1d4ed8;
        }
        
        /* QR Code */
        .qr-code {
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .peer-id-display {
            background: #f0f8ff;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 0.75rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            word-break: break-all;
            border: 1px solid #e0f2fe;
            font-size: 0.875rem;
        }
        
        /* Image Overlay */
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        .image-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 0.75rem;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6b7280;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .container {
                padding: 2rem 1rem;
            }
            
            .nav-content {
                padding: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .header h2 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .card-header, .card-content {
                padding: 1.5rem;
            }
            
            textarea {
                height: 5rem;
                font-size: 16px; /* Prevent iOS zoom */
            }
            
            .input-buttons {
                right: 0.375rem;
                top: 0.375rem;
            }
            
            .input-btn {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.5rem;
            }
            
            .preview-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            input, button, textarea {
                font-size: 16px; /* Prevent iOS zoom */
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 1rem 0.75rem;
            }
            
            .header {
                margin-bottom: 2rem;
            }
            
            .header h2 {
                font-size: 1.75rem;
            }
            
            .card-header, .card-content {
                padding: 1rem;
            }
            
            textarea {
                padding-right: 4rem;
            }
            
            .input-btn {
                width: 1.5rem;
                height: 1.5rem;
                font-size: 0.45rem;
            }
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <h1>P2P File Share</h1>
            <div class="nav-status">
                <span class="status-text">Powered by WebRTC</span>
                <div class="status-indicator"></div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h2>Secure Peer-to-Peer File Transfer</h2>
            <p>Share files directly between devices with end-to-end encryption and zero server storage</p>
        </div>

        <!-- Status -->
        <div class="status disconnected" id="status">
            Waiting for connection...
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Connection Setup -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Start Connection</h3>
                        <p class="card-subtitle">Create a new peer connection</p>
                    </div>
                    <button class="btn-secondary" onclick="createConnection()" id="createBtn">Create</button>
                </div>
                <div class="card-content">
                    <div id="myPeerId" class="peer-id-display" style="display: none;"></div>
                    <div id="qrCode" class="qr-code"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Join Connection</h3>
                        <p class="card-subtitle">Connect to an existing peer</p>
                    </div>
                </div>
                <div class="card-content">
                    <input type="text" id="peerIdInput" placeholder="Enter Peer ID">
                    <button onclick="connectToPeer()" id="connectBtn">Connect</button>
                </div>
            </div>
            
            <!-- Message & File Section -->
            <div class="message-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Messages & Files</h3>
                            <p class="card-subtitle">Send text messages and any file type</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="drop-zone" id="dropZone">
                            Drop files here or use the buttons below
                        </div>
                        
                        <div class="input-area">
                            <textarea id="messageInput" placeholder="Type your message..." disabled></textarea>
                            <div class="input-buttons">
                                <button class="input-btn file-btn" onclick="selectFile()" title="Select File" disabled id="fileBtn">FILE</button>
                                <button class="input-btn paste-btn" onclick="pasteText()" title="Paste Text" disabled id="pasteBtn">PASTE</button>
                            </div>
                        </div>
                        
                        <input type="file" id="fileInput" onchange="handleFileSelect(event)">
                        
                        <div id="filePreview" style="display: none;">
                            <div class="preview-container">
                                <div id="previewContainer">
                                    <img id="previewImg" class="image-preview" style="display: none;">
                                    <div id="fileIcon" class="file-icon" style="display: none;">FILE</div>
                                </div>
                                <div class="file-details">
                                    <div id="fileName"></div>
                                    <div id="fileSize" class="file-info"></div>
                                    <div id="fileType" class="file-info"></div>
                                    <button onclick="clearPreview()" class="clear-btn">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
                        
                        <div class="message-history" id="messageHistory">
                            <div style="text-align: center; color: #6b7280; font-style: italic;">
                                Connect to start messaging and file sharing
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Overlay -->
    <div class="image-overlay" id="imageOverlay" onclick="closeImageOverlay()">
        <img id="overlayImg">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <script>
        let peer = null;
        let connection = null;
        let isConnected = false;
        let selectedFile = null;
        
        const statusEl = document.getElementById('status');
        const createBtn = document.getElementById('createBtn');
        const connectBtn = document.getElementById('connectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const fileBtn = document.getElementById('fileBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const messageInput = document.getElementById('messageInput');
        const messageHistory = document.getElementById('messageHistory');
        const myPeerIdEl = document.getElementById('myPeerId');
        const peerIdInput = document.getElementById('peerIdInput');
        const qrCodeEl = document.getElementById('qrCode');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const previewImg = document.getElementById('previewImg');
        const fileIcon = document.getElementById('fileIcon');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        const imageOverlay = document.getElementById('imageOverlay');
        const overlayImg = document.getElementById('overlayImg');
        
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function generatePeerId() {
            return 'share-' + Math.random().toString(36).substr(2, 9);
        }
        
        function createConnection() {
            const peerId = generatePeerId();
            
            updateStatus('Initializing connection...', 'connecting');
            createBtn.innerHTML = '<span class="loading"></span> Creating...';
            createBtn.disabled = true;
            
            const peerOptions = {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            };
            
            peer = new Peer(peerId, peerOptions);
            
            peer.on('open', (id) => {
                console.log('My peer ID is: ' + id);
                myPeerIdEl.textContent = `Your ID: ${id}`;
                myPeerIdEl.style.display = 'block';
                
                createQRCode(id);
                
                updateStatus('Waiting for peer connection - Share your ID or QR code', 'connecting');
                createBtn.textContent = 'Connection Created';
                connectBtn.disabled = false;
            });
            
            peer.on('connection', (conn) => {
                connection = conn;
                setupConnection();
                updateStatus('Connection established successfully!', 'connected');
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateStatus('Error occurred: ' + err.message, 'disconnected');
                resetButtons();
            });
        }
        
        function createQRCode(peerId) {
            const currentUrl = window.location.href.split('?')[0];
            const qrUrl = `${currentUrl}?connect=${peerId}`;
            
            const canvas = document.createElement('canvas');
            const qr = new QRious({
                element: canvas,
                value: qrUrl,
                size: 200,
                foreground: '#111827',
                background: 'white'
            });
            
            qrCodeEl.innerHTML = '';
            qrCodeEl.appendChild(canvas);
            
            const label = document.createElement('div');
            label.textContent = 'Scan QR code for instant connection';
            label.style.marginTop = '10px';
            label.style.fontSize = '0.875rem';
            label.style.color = '#6b7280';
            qrCodeEl.appendChild(label);
            
            const urlDisplay = document.createElement('div');
            urlDisplay.textContent = qrUrl;
            urlDisplay.style.marginTop = '10px';
            urlDisplay.style.fontSize = '0.75rem';
            urlDisplay.style.color = '#9ca3af';
            urlDisplay.style.wordBreak = 'break-all';
            urlDisplay.style.padding = '8px';
            urlDisplay.style.background = '#f9fafb';
            urlDisplay.style.borderRadius = '6px';
            urlDisplay.style.cursor = 'pointer';
            urlDisplay.title = 'Click to copy';
            
            urlDisplay.onclick = () => {
                navigator.clipboard.writeText(qrUrl).then(() => {
                    const originalText = urlDisplay.textContent;
                    urlDisplay.textContent = '✓ URL copied to clipboard';
                    setTimeout(() => {
                        urlDisplay.textContent = originalText;
                    }, 2000);
                });
            };
            
            qrCodeEl.appendChild(urlDisplay);
        }
        
        function connectToPeer() {
            const targetPeerId = peerIdInput.value.trim();
            if (!targetPeerId) {
                alert('Please enter a peer ID');
                return;
            }
            
            if (!peer) {
                const peerOptions = {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                };
                
                peer = new Peer(generatePeerId(), peerOptions);
                
                peer.on('open', () => {
                    connectToPeerDirect(targetPeerId);
                });
                
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    updateStatus('Error occurred: ' + err.message, 'disconnected');
                    resetButtons();
                });
            } else {
                connectToPeerDirect(targetPeerId);
            }
        }
        
        function connectToPeerDirect(targetPeerId) {
            updateStatus('Connecting...', 'connecting');
            connectBtn.innerHTML = '<span class="loading"></span> Connecting...';
            connectBtn.disabled = true;
            
            connection = peer.connect(targetPeerId);
            setupConnection();
        }
        
        function setupConnection() {
            connection.on('open', () => {
                isConnected = true;
                updateStatus('Connection established successfully!', 'connected');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                fileBtn.disabled = false;
                pasteBtn.disabled = false;
                connectBtn.textContent = 'Connected';
                createBtn.disabled = true;
                
                clearMessageHistory();
                addSystemMessage('Connection established. You can now send messages and files.');
            });
            
            connection.on('data', (data) => {
                console.log('Received:', data);
                if (data.type === 'text') {
                    addMessage(data.message, 'received', data.timestamp);
                } else if (data.type === 'image') {
                    addImageMessage(data.fileData, data.filename, data.filesize, 'received', data.timestamp, data.message);
                } else if (data.type === 'file') {
                    addFileMessage(data.fileData, data.filename, data.filesize, data.filetype, 'received', data.timestamp, data.message);
                }
            });
            
            connection.on('close', () => {
                isConnected = false;
                updateStatus('Connection closed', 'disconnected');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                fileBtn.disabled = true;
                pasteBtn.disabled = true;
                resetButtons();
                addSystemMessage('Connection closed.');
            });
            
            connection.on('error', (err) => {
                console.error('Connection error:', err);
                updateStatus('Connection error: ' + err.message, 'disconnected');
                resetButtons();
            });
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            const timestamp = new Date().toLocaleTimeString();
            
            if (!isConnected) return;
            
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = e.target.result;
                    const isImage = selectedFile.type.startsWith('image/');
                    
                    const data = {
                        type: isImage ? 'image' : 'file',
                        fileData: fileData,
                        filename: selectedFile.name,
                        filesize: formatFileSize(selectedFile.size),
                        filetype: selectedFile.type,
                        timestamp: timestamp
                    };
                    
                    if (message) {
                        data.message = message;
                    }
                    
                    connection.send(data);
                    
                    if (isImage) {
                        addImageMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), 'sent', timestamp, message);
                    } else {
                        addFileMessage(fileData, selectedFile.name, formatFileSize(selectedFile.size), selectedFile.type, 'sent', timestamp, message);
                    }
                    
                    clearPreview();
                    messageInput.value = '';
                };
                reader.readAsDataURL(selectedFile);
            }
            else if (message) {
                const data = {
                    type: 'text',
                    message: message,
                    timestamp: timestamp
                };
                
                connection.send(data);
                addMessage(message, 'sent', timestamp);
                messageInput.value = '';
            }
        }
        
        function addMessage(message, type, timestamp) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const messageText = document.createElement('div');
            messageText.textContent = message;
            
            // コピーボタンを追加（送信・受信両方）
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy';
            copyBtn.style.cssText = 'font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-top: 0.5rem; background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 0.25rem; cursor: pointer; color: inherit;';
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(message).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                }).catch(() => {
                    copyBtn.textContent = 'Failed';
                    setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                });
            };
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = timestamp;
            
            messageEl.appendChild(messageText);
            messageEl.appendChild(copyBtn);
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addImageMessage(imageData, filename, filesize, type, timestamp, message = '') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} image-message`;
            
            const imgEl = document.createElement('img');
            imgEl.src = imageData;
            imgEl.onclick = () => showImageOverlay(imageData);
            imgEl.style.maxWidth = '100%';
            imgEl.style.borderRadius = '0.5rem';
            imgEl.style.cursor = 'pointer';
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info';
            fileInfoEl.textContent = `${filename} (${filesize})`;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = timestamp;
            
            messageEl.appendChild(imgEl);
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.5rem';
                messageEl.appendChild(messageText);
            }

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.style.cssText = 'margin-top: 0.5rem; padding: 0.375rem 0.75rem; font-size: 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer;';
            saveBtn.onclick = () => downloadFile(imageData, filename);
            messageEl.appendChild(saveBtn);
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addFileMessage(fileData, filename, filesize, filetype, type, timestamp, message = '') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} file-message`;
            
            const fileInfoEl = document.createElement('div');
            fileInfoEl.className = 'file-info-display';
            
            const fileIconEl = document.createElement('div');
            fileIconEl.className = 'file-icon';
            fileIconEl.style.fontSize = '0.75rem';
            fileIconEl.style.fontWeight = 'bold';
            fileIconEl.style.textAlign = 'center';
            fileIconEl.style.marginBottom = '0.75rem';
            fileIconEl.textContent = getFileIcon(filetype);
            
            const fileNameEl = document.createElement('div');
            fileNameEl.style.fontWeight = '600';
            fileNameEl.style.marginBottom = '0.375rem';
            fileNameEl.textContent = filename;
            
            const fileDetailsEl = document.createElement('div');
            fileDetailsEl.className = 'file-info';
            fileDetailsEl.innerHTML = `${getFileTypeName(filetype)} • ${filesize}`;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'file-download';
            downloadBtn.textContent = 'Download';
            downloadBtn.onclick = () => downloadFile(fileData, filename);
            
            fileInfoEl.appendChild(fileIconEl);
            fileInfoEl.appendChild(fileNameEl);
            fileInfoEl.appendChild(fileDetailsEl);
            fileInfoEl.appendChild(downloadBtn);
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = timestamp;
            
            messageEl.appendChild(fileInfoEl);
            
            if (message) {
                const messageText = document.createElement('div');
                messageText.textContent = message;
                messageText.style.marginTop = '0.75rem';
                messageText.style.padding = '0.75rem';
                messageText.style.background = 'rgba(255,255,255,0.5)';
                messageText.style.borderRadius = '0.5rem';
                messageEl.appendChild(messageText);
            }
            
            messageEl.appendChild(timeEl);
            
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function addSystemMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.style.textAlign = 'center';
            messageEl.style.color = '#6b7280';
            messageEl.style.fontStyle = 'italic';
            messageEl.style.margin = '0.75rem 0';
            messageEl.style.fontSize = '0.875rem';
            messageEl.textContent = message;
            messageHistory.appendChild(messageEl);
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        function clearMessageHistory() {
            messageHistory.innerHTML = '';
        }
        
        function resetButtons() {
            createBtn.textContent = 'Create';
            createBtn.disabled = false;
            connectBtn.textContent = 'Connect';
            connectBtn.disabled = false;
        }
        
        function selectFile() {
            fileInput.click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
            }
        }
        
        function showFilePreview(file) {
            const isImage = file.type.startsWith('image/');
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    fileIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewImg.style.display = 'none';
                fileIcon.style.display = 'flex';
                fileIcon.textContent = getFileIcon(file.type);
            }
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileType.textContent = getFileTypeName(file.type);
            filePreview.style.display = 'block';
        }
        
        function clearPreview() {
            selectedFile = null;
            filePreview.style.display = 'none';
            fileInput.value = '';
        }
        
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'IMG';
            if (mimeType.startsWith('video/')) return 'VID';
            if (mimeType.startsWith('audio/')) return 'AUD';
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('word')) return 'DOC';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'XLS';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'PPT';
            if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('7z')) return 'ZIP';
            if (mimeType.includes('text')) return 'TXT';
            if (mimeType.includes('json') || mimeType.includes('xml')) return 'DATA';
            return 'FILE';
        }
        
        function getFileTypeName(mimeType) {
            const typeMap = {
                'application/pdf': 'PDF Document',
                'application/msword': 'Word Document',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word Document',
                'application/vnd.ms-excel': 'Excel Spreadsheet',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel Spreadsheet',
                'application/vnd.ms-powerpoint': 'PowerPoint Presentation',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPoint Presentation',
                'application/zip': 'ZIP Archive',
                'application/x-rar-compressed': 'RAR Archive',
                'text/plain': 'Text File',
                'text/csv': 'CSV File',
                'application/json': 'JSON File',
                'text/xml': 'XML File'
            };
            
            if (mimeType.startsWith('image/')) return 'Image File';
            if (mimeType.startsWith('video/')) return 'Video File';
            if (mimeType.startsWith('audio/')) return 'Audio File';
            
            return typeMap[mimeType] || 'File';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showImageOverlay(imageData) {
            overlayImg.src = imageData;
            imageOverlay.style.display = 'flex';
        }
        
        function closeImageOverlay() {
            imageOverlay.style.display = 'none';
        }
        
        function downloadFile(fileData, filename) {
            const link = document.createElement('a');
            link.href = fileData;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function pasteText() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    messageInput.value = text;
                    messageInput.focus();
                } else {
                    alert('No text found in clipboard.');
                }
            } catch (err) {
                console.error('Clipboard access error:', err);
                alert('Could not access clipboard. Please check browser permissions.');
            }
        }
        
        // Drag and drop functionality
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                selectedFile = file;
                showFilePreview(file);
            }
        });
        
        // Auto-connect from URL parameter
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const connectToPeerId = urlParams.get('connect');
            
            if (connectToPeerId) {
                updateStatus('Starting auto-connection from QR code...', 'connecting');
                peerIdInput.value = connectToPeerId;
                
                setTimeout(() => {
                    connectToPeer();
                    
                    const cleanUrl = window.location.href.split('?')[0];
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    const messageHistory = document.getElementById('messageHistory');
                    const systemMsg = document.createElement('div');
                    systemMsg.style.textAlign = 'center';
                    systemMsg.style.color = '#6b7280';
                    systemMsg.style.fontStyle = 'italic';
                    systemMsg.style.margin = '0.75rem 0';
                    systemMsg.style.fontSize = '0.875rem';
                    systemMsg.textContent = 'Auto-connection started from QR code.';
                    messageHistory.appendChild(systemMsg);
                }, 1000);
            }
        });
        
        // Enter key to send message
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Ctrl+V for text paste
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && isConnected) {
                if (document.activeElement === messageInput) {
                    return;
                }
                e.preventDefault();
                pasteText();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (connection) {
                connection.close();
            }
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>
